<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>localStorage</title>
<style>
span {
}
input {
  border: none;
  height: 100%;
  font-size: 1em;
  margin-left: -1px;
}
div {
  line-height: 1.61em;
  min-height: 1.61em;
  vertical-align: top;
  display: inline-block;
  border-right: 1px solid;
  border-bottom: 1px solid;
  border-color: #a2a2a2;
}
div > div {
  border-right: none;
  border-bottom: none;
}
div > div > div {
  display: block;
  height: 1.61em;
  padding: 0.4em 0.5em;
  border-left: 1px solid;
  border-top: 1px solid;
  border-color: #a2a2a2;
}
.info:hover:after {
  content: 'Put some example info about this awesome app, here.';
position: absolute;
background: red;
}
</style>
<script type="text/javascript">
//
// GLOBAL-VARS
//
var cellDeli = ','
var columnDeli = '\n'
//
// COMMONS
//
function getNextSibling(ele) {
  var next_ele=ele.nextSibling
  while (next_ele.nodeType != 1) {
    next_ele=next_ele.nextSibling
  }
  return next_ele
};

function getFirstChild(ele) {
  var first_child=ele.firstChild
  while (first_child.nodeType != 1) {
    first_child=getNextSibling(first_child)
  }
  return first_child
}
//
// KEYS
//
function addKey(key, keys=null) {
  if(keys === null) {
    keys = getKeys()
  }
  if(localStorage.getItem(key) === null) {
    var delisAmount = getRowDelisAmount()
    var vals = key + cellDeli.repeat(delisAmount)
    if(keys === null) {
      keys = getKeys()
    }
    keys.push(key)
    localStorage.setItem(key, vals)
    showTable(keys)
  }
  return keys
}
function delKey(key) {
  localStorage.removeItem(key)
  showTable()
}
function editKey(oldKey, newKey) {
  var vals = localStorage.getItem(oldKey)
  vals = vals.split(cellDeli)
  vals[0] = newKey
  vals = vals.join(cellDeli)
  localStorage.removeItem(oldKey)
  localStorage.setItem(newKey, vals)
}
function getKeys() {
  var keys = []
  for(var i in localStorage) {
    if(typeof(localStorage[i]) == 'string') {
      keys.push(localStorage[i].split(cellDeli)[0])
    }
  }
  return keys
}
//
// TABLE
//
function getTable(keys) {
  var csv = ''
  for(var i in keys) {
    csv += localStorage.getItem(keys[i]) + columnDeli
  }
  if(csv != '') {
    csv = csv.slice(0, -columnDeli.length)
  }
  return csv
}
function setTable(csv) {
  localStorage.clear()
  var rows = []
  var columns = csv.split(columnDeli)
  for(var i in columns) {
    var cells = columns[i].split(cellDeli)
    for(var j in cells) {
      if(j == rows.length) {
        rows.push([])
      }
      rows[j][i] = cells[j]
    }
  }
  for(var i in rows) {
    var key = rows[i][0]
    var val = rows[i].join(cellDeli)
    localStorage.setItem(key, val)
  }
}
function showTable(keys=null) {

  if(keys === null) { keys = getKeys() }
  var table = getTable(keys)
  var rows = table.split(columnDeli)

  var html = '<div>'

  // Add first column, add-col-button and row-nrs:
  html += '<div>'
    html += '<div class="info">'
    html += 'i'
    html += '</div>'
    html += '<div class="addKey" title="Add column" tabindex="1">'
    html += '+'
    html += '</div>'
  if(table != '') {
    var cells = rows[0].split(cellDeli)
    for(var j in cells) {
      if(j != 0) {
        html += '<div>'
          html += '<span class="rowUp">'
            html += '^'
          html += '</span>'
          html += j
          html += '<span class="rowDown">'
            html += 'v'
          html += '</span>'
        html += '</div>'
      }
    }
  }
  html += '</div>'

  if(table != '') {
  // Add columns:
  for(var i in rows) {
    html += '<div>'
    var row = rows[i]
    var cells = row.split(cellDeli)
    for(var j in cells) {
      if(j == 0) {
        html += '<div><span class="columnToLeft"><</span><input tabindex="1"><span class="columnToRight">></span></div>' // new-row-cell
        html += '<div class="columnHeaderCell editCell" tabindex="' + j + 2 + '">'
      }
      else { // except keys
        html += '<div class="editCell" tabindex="' + j + 2 + '">'
      }
      html += cells[j]
      html += '</div>'
    }
    html += '</div>'
  }

  // Add last column, delete-buttons:
  html += '<div>'
    html += '<div class="delTable">'
    html += 'X'
    html += '</div>'
    html += '<div class="delKey" title="Remove column" tabindex="0">'
    html += 'X'
    html += '</div>'
    html += '<div class="delRow" tabindex="0">X</div>'
    .repeat(getRowDelisAmount())
  html += '</div>'  // end of last-column
  } // table != ''
  html += '</div>' //  end of table

  document.getElementsByTagName('body')[0].innerHTML = html
  addListeners(keys)
  if(document.getElementsByTagName('input').length > 0) {
    document.getElementsByTagName('input')[0].focus()
  }
  else {
    document.getElementsByClassName('addKey')[0].click()
  }
}
//
// COLUMN
//
function getColKey(cellEle) {
  var colKey = null
  cellEle = cellEle.parentNode.parentNode
  cellEle = getFirstChild(cellEle)
  cellEle = getNextSibling(cellEle)
  if(cellEle.childNodes.length > 0
    && cellEle.childNodes[0].tagName !== undefined
    && cellEle.childNodes[0].tagName.toLowerCase() == 'input') {
    colKey = cellEle.childNodes[0].value
  }
  else {
    colKey = cellEle.innerHTML
  }
  return colKey
}
//
// ROW
//
function addRow(csv, keys=null) {
  if(keys === null) {
    keys = getKeys()
  }
  var vals = csv.split(cellDeli)
  for(var i in keys) {
    var key = keys[i]
    if(localStorage.getItem(key) === null) {
      addKey(key, keys)
    }
    var oldVals = localStorage.getItem(key)
    var newVals = oldVals + cellDeli + vals[i]
    localStorage.setItem(key, newVals)
  }
  showTable(keys)
}
function getRowDelisAmount() {
  var amount = 0
  var keys = getKeys()
  if(keys[0] !== undefined &&
     localStorage.getItem(keys[0]) !== null) {
    amount = localStorage.getItem([keys[0]]).split(cellDeli).length - 1
  }
  return amount
}
function getRowNr(cellEle) {
  var rowNr = 0
  var previousEle = cellEle
  while(previousEle !== null) {
    previousEle = previousEle.previousSibling
    if(previousEle !== null) {
      while (previousEle.nodeType != 1) {
        previousEle = previousEle.previousSibling
      }
    }
    rowNr +=1
  }
  rowNr -= 2 // subtract first two cells: input and column-header
  return rowNr
}
function delRow(pos, keys=null) {
  if(keys === null) {
    keys = getKeys()
  }
  for(var i in keys) {
    var vals = localStorage.getItem(keys[i])
    vals = vals.split(cellDeli)
    vals.splice(pos, 1)
    vals.join(cellDeli)
    localStorage.setItem(keys[i], vals)
  }
}
function moveRow(pos, direction, keys=null) {
  if(keys === null) {
    keys = getKeys()
  }
  for(var i in keys) {
    var vals = localStorage.getItem(keys[i])
    vals = vals.split(cellDeli)
    if(direction == 'down') {
      vals = moveArrayItemToRight(vals, vals[pos])
    }
    else {
      vals = moveArrayItemToLeft(vals, vals[pos])
    }
    localStorage.setItem(keys[i], vals)
    showTable(keys)
  }
}
//
// LISTEN
//
function addButtonsListener(keys) {
  var addKeyButton = document.getElementsByClassName('addKey')[0]
  var columnToLeftButtons = document.getElementsByClassName('columnToLeft')
  var columnToRightButtons = document.getElementsByClassName('columnToRight')
  var editCellButtons = document.getElementsByClassName('editCell')
  var delKeyButton = document.getElementsByClassName('delKey')[0]
  var delRowButtons = document.getElementsByClassName('delRow')
  var delTableButton = document.getElementsByClassName('delTable')[0]
  var rowDownButtons = document.getElementsByClassName('rowDown')
  var rowUpButtons = document.getElementsByClassName('rowUp')
  for(var i in rowDownButtons) {
    rowDownButtons[i].onclick = function(eve) {
      // Get rowNr, subtract the first row for new cells:
      var rowNr = getPosInParent(eve.target.parentNode) - 1
      moveRow(rowNr, 'down', keys)
    }
  }
  for(var i in rowUpButtons) {
    rowUpButtons[i].onclick = function(eve) {
      // Get rowNr, subtract the first row for new cells:
      var rowNr = getPosInParent(eve.target.parentNode) - 1
      moveRow(rowNr, 'up', keys)
    }
  }
  for(var i in columnToRightButtons) {
    columnToRightButtons[i].onclick = function(eve) {
      moveColumn(keys, eve.target, 'right')
    }
  }
  for(var i in columnToLeftButtons) {
    columnToLeftButtons[i].onclick = function(eve) {
      moveColumn(keys, eve.target, 'left')
    }
  }
  addKeyButton.onclick = function(eve) {
      addKeyButton.innerHTML = '<input>'
      var addKeyInput = addKeyButton.getElementsByTagName('input')[0]
console.log(addKeyInput)
      addKeyInput.focus()
      addKeyInput.onkeydown = function(eve) {
        if(eve.keyCode == 13) {
          keys = addKey(addKeyInput.value, keys)
        }
      }
  }
  addKeyButton.onkeydown = function(eve) {
    if(eve.keyCode == 13) {
      eve.target.click()
    }
  }
  for(var i in editCellButtons) {
    editCellButtons[i].onclick = function(eve) {
      var hasInput = true
      var tag = eve.target
      var tagName = eve.target.tagName.toLowerCase()
      // First check if there is an input already:
      if(tagName != 'input') {
        if(tag.childNodes.length > 0 && tag.childNodes[0].type != 'text') {
          hasInput = false
        }
        else {
          hasInput = false
        }
      }
      else {
        hasInput = false
      }
      // If not, insert input:
      if(!hasInput) { 
        var tagText = tag.innerHTML
        tag.innerHTML = '<input value="' + eve.target.innerHTML  +
                        '" tabindex="' + tag.getAttribute('tabindex') + '">'
        var input = tag.getElementsByTagName('input')[0]
        input.focus()
        // Key pressed in input:
        input.onkeydown = function(eve) {
          if(eve.keyCode == 13) {
            saveCell(eve.target, tagText)
            tag.innerHTML = eve.target.value
            tag.focus()
          }
        }
        // Input looses focus:
        input.onblur = function(eve) {
          saveCell(eve.target, tagText)
          tag.innerHTML = eve.target.value
        } // input blur
      } // not hasInput
    } // click  button
    // When a user hits enter in a focused cell...
    editCellButtons[i].onkeydown = function(eve) {
      // ... simulate a click to trigger the click-procedure:
      if(eve.keyCode == 13) {
        eve.target.click()
      }
    }
    // When a cell gets focus, simulate a click, too:
    editCellButtons[i].onfocus = function(eve) {
      eve.target.click()
    }
  } // for each editButton
  if(delKeyButton !== undefined) {
    delKeyButton.onclick = function(eve) {
      delKeyButton.innerHTML = '<input>'
      var delKeyInput = delKeyButton.getElementsByTagName('input')[0]
      delKeyInput.focus()
      delKeyInput.onkeydown = function(eve) {
        if(eve.keyCode == 13) {
          delKey(delKeyInput.value)
        }
      }
    }
    delKeyButton.onkeydown = function(eve) {
      if(eve.keyCode == 13) {
        eve.target.click()
      }
    }
    for(var i in delRowButtons) {
      delRowButtons[i].onclick = function(eve) {
        var pos = getRowNr(eve.target)
        delRow(pos)
        showTable(keys)
      }
      delRowButtons[i].onkeydown = function(eve) {
        if(eve.keyCode == 13) {
          eve.target.click()
        }
      }
    }
    delTableButton.onclick = function(eve) {
      if(confirm('Do you really want to delete everything?')) {
        localStorage.clear()
        showTable()
      }
    }
    delTableButton.onkeydown = function(eve) {
      if(eve.keyCode == 13) {
        eve.target.click()
      }
    }
  } // delKeyButton != undefined
}
function saveCell(editCellInputEle, oldKey=null) {
  var rowNr = getRowNr(editCellInputEle.parentNode)
  if(rowNr == 0) { // is column-header
    editKey(oldKey, editCellInputEle.value)
  }
  else { // is ordinary-cell
    var colKey = getColKey(editCellInputEle)
    var val = editCellInputEle.value
    var vals = localStorage.getItem(colKey).split(cellDeli)
    vals[rowNr] = val
    vals = vals.join(cellDeli)
    localStorage.setItem(colKey, vals)
  }
}
function addInputsListener(keys) {
  var inputs = document.getElementsByTagName('input')
  for(var i in inputs) {
    var input = inputs[i]
    input.onkeydown = function(eve) {
      if(eve.keyCode == 13) {
        var vals = ''
        for(var j in inputs) {
          if(typeof(inputs[j]) == 'object') {
            vals += inputs[j].value + cellDeli
          }
        }
        vals = vals.slice(0, -cellDeli.length)
        addRow(vals, keys)
      }
    }
  }
}
function getPosInParent(ele) {
  var pos = 0
  while(ele.previousSibling !== null) {
    if(ele.previousSibling === null) { break }
    ele = ele.previousSibling
    pos += 1
  }
  return pos
}
function cursorIsAtBeginning(input) {
  if(input.selectionStart == 0
    && input.selectionEnd == 0) {
    return true
  }
  else {
    return false
  }
}
function cursorIsAtEnd(input) {
  if(input.selectionStart == input.value.length
    && input.selectionEnd == input.value.length) {
    return true
  }
  else {
    return false
  }
}
function addArrowKeysListener() {
  document.body.onkeydown = function(eve) {
    if(eve.keyCode == 37
    || eve.keyCode == 38
    || eve.keyCode == 39
    || eve.keyCode == 40) {
     var isInput = false 
     var currentEle = document.activeElement

      // If we're in an input, go one up, into cell:
      if(currentEle.tagName.toLowerCase() == 'input') {
        var isInput = true
        var atStart = cursorIsAtBeginning(currentEle)
        var atEnd = cursorIsAtEnd(currentEle)
        currentEle = currentEle.parentNode
      }

      // Arrow-left or arrow-right was pressed:
      if(eve.keyCode == 37 || eve.keyCode == 39) { 

        var pos = getPosInParent(currentEle)

        // First, grab parent:
        currentEle = currentEle.parentNode

        // Arrow-left was pressed:
        if(eve.keyCode == 37) {
          // Get previous uncle:
          if(currentEle.previousSibling !== null) {
            currentEle = currentEle.previousSibling
          }
        }

        // Arrow-right was pressed:
        if(eve.keyCode == 39) {

          // Get next uncle:
          if(currentEle.nextSibling !== null) {
            currentEle = currentEle.nextSibling
          }
        }

        // Now, get cousin of same position:
        currentEle = currentEle.childNodes[pos]

        if(! isInput
        || eve.keyCode == 37 && atStart
        || eve.keyCode == 39 && atEnd) {
          eve.preventDefault() // Inhibit right move before...
          currentEle.focus() // ...focusing new ele.
        }
      }

      // Arrow-up was pressed:
      else if(eve.keyCode == 38) {
        if(currentEle.previousSibling != null) {
          currentEle.previousSibling.focus()
        }
      }

      // Arrow-down was pressed:
      else if(eve.keyCode == 40) {
        if(currentEle.nextSibling != null) {
          currentEle.nextSibling.focus()
        }
      }
    }
  }
}
function moveArrayItemToLeft(arr, item, steps=1) {
  while(steps > 0) {
    steps -= 1
    var pos = arr.indexOf(item) // TODO: regard dups
    arr.splice(pos, 1) // remove item of pos
    arr.splice(pos - 1, 0, item) // add to pos-1
  }
  return arr
}
function moveArrayItemToRight(arr, item, steps=1) {
  while(steps > 0) {
    steps -= 1
    var pos = arr.indexOf(item) // TODO: regard dups
    arr.splice(pos, 1) // remove item of pos
    arr.splice(pos + 1, 0, item) // add item to pos+1
  }
  return arr
}
function moveColumn(keys, button, direction) {
    var colKey = button.parentNode.parentNode
                 .getElementsByClassName('columnHeaderCell')[0]
                 .innerHTML
    if(direction == 'right') {
      moveArrayItemToRight(keys, colKey, 1)
    }
    else if(direction == 'left') {
      moveArrayItemToLeft(keys, colKey, 1)
    }
    showTable(keys)
}
function addListeners(keys) {
  addButtonsListener(keys)
  addInputsListener(keys)
  addArrowKeysListener(keys)
}
//
// MAIN
//
document.addEventListener("DOMContentLoaded", function(event) { 
  var csv = 'x,y,z\nFirstname,Lastname,Passion\nIda,Ebkes,Python\nAda,Ebkes,Lion'
//  setTable(csv)
//  var keys = csv.split(columnDeli)[0].split(cellDeli)
  var keys = getKeys() 
  showTable(keys)
console.log(localStorage)

}); // dom loaded
</script>
</head>
<body lang="en" dir="ltr">
</body>
</html>
