<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>localStorage</title>
<style>
/*
body,input {background:#111;color:e2e2e2;}
*/
input {
  border: 1px solid #a2a2a2;
  height: 100%;
  font-size: 1em;
}
div {
  line-height: 1.61em;
  min-height: 1.61em;
  vertical-align: top;
  display: inline-block;
  border-right: 1px solid;
  border-bottom: 1px solid;
  border-color: #a2a2a2;
}
input:focus,
div:focus {
  background: #222 !important;
  background: lightyellow !important;
  background: yellow !important;
}
div > div {
  border-right: none;
  border-bottom: none;
}
div > div > div {
  display: block;
  height: 1.61em;
  padding: 0.4em 0.5em;
  border-left: 1px solid;
  border-top: 1px solid;
  border-color: #a2a2a2;
}
/* Hide localStorage-keys: 
div > div > div:nth-child(2) {
min-height: 0;
height: 0;
overflow: hidden;
padding: 0;
border: none;
}
*/
div > div:first-child > div,
div > div:last-child > div,
div > div > div:first-child,
div > div > div:nth-child(3) {
  background: #e2e2e2;
}
/* Column-headers */
div > div > div:nth-child(3) {
  font-weight: bold;
}
div > div:last-child > div:nth-child(3),
div > div:first-child > div:nth-child(3) {
  font-weight: normal;
}
</style>
<script type="text/javascript">
//
// GLOBAL-VARS
//
var cellDeli = ','
var columnDeli = '\n'
//
// COMMONS
//
function getNextSibling(ele) {
  var next_ele=ele.nextSibling
  while (next_ele.nodeType != 1) {
    next_ele=next_ele.nextSibling
  }
  return next_ele
};

function getFirstChild(ele) {
  var first_child=ele.firstChild
  while (first_child.nodeType != 1) {
    first_child=getNextSibling(first_child)
  }
  return first_child
}
//
// KEYS
//
function addKey(key, keys=null) {
  if(keys === null) {
    keys = getKeysOfLocalStorage()
  }
  if(localStorage.getItem(key) === null) {
    var delisAmount = getRowDelisAmount()
    var vals = key + cellDeli.repeat(delisAmount)
    if(keys === null) {
      keys = getKeysOfLocalStorage()
    }
    keys.push(key)
    localStorage.setItem(key, vals)
    showTable(keys)
  }
  return keys
}
function delKey(key) {
  localStorage.removeItem(key)
  showTable()
}
function editKey(oldKey, newKey) {
  var vals = localStorage.getItem(oldKey)
  vals = vals.split(cellDeli)
  vals[0] = newKey
  vals = vals.join(cellDeli)
  localStorage.removeItem(oldKey)
  localStorage.setItem(newKey, vals)
}
function getKeysOfLocalStorage() {
  var keys = []
  for(var i in localStorage) {
    if(typeof(localStorage[i]) == 'string') {
      keys.push(localStorage[i].split(cellDeli)[0])
    }
  }
  return keys
}
function getKeysOfCsv(csv) {
  return csv.split(columnDeli)[0].split(cellDeli)
}
//
// TABLE
//
function getTable(keys) {
  var csv = ''
  for(var i in keys) {
    csv += localStorage.getItem(keys[i]) + columnDeli
  }
  if(csv != '') {
    csv = csv.slice(0, -columnDeli.length)
  }
  return csv
}
function iniTable(csv) {
  localStorage.clear()
  setTable(csv)
  var keys = getKeysOfCsv(csv)
  showTable(keys)
  return keys
}
function setTable(csv) {
  localStorage.clear()
  var rows = []
  var columns = csv.split(columnDeli)
  for(var i in columns) {
    var cells = columns[i].split(cellDeli)
    for(var j in cells) {
      if(j == rows.length) {
        rows.push([])
      }
      rows[j][i] = cells[j]
    }
  }
  for(var i in rows) {
    var key = rows[i][0]
    var val = rows[i].join(cellDeli)
    localStorage.setItem(key, val)
  }
}
function showTable(keys=null) {
//console.log(document.activeElement)
  if(keys === null) {
    keys = getKeysOfLocalStorage()
  }
  var html = '<div>'
  var table = getTable(keys)
  var rows = table.split(columnDeli)
  for(var i in rows) {
    if(i == 0) {
      html += '<div>'
      html += '<div class="addKey" title="Add column" tabindex="1">'
      html += '+'
      html += '</div>'
    var row = rows[i]
    var cells = row.split(cellDeli)
    for(var j in cells) {
        html += '<div>'
        if(j != 0) {
          html += j
        }
        html += '</div>'
      }
    html += '</div>'
    }
  }
  for(var i in rows) {
    html += '<div>'
    var row = rows[i]
    var cells = row.split(cellDeli)
    for(var j in cells) {
      if(j == 0) {
        html += '<div><input tabindex="1"></div>' // new-row-cell
        html += '<div class="editCell">'
      }
      else { // except keys
        html += '<div class="editCell" tabindex="' + j + 2 + '">'
      }
      html += cells[j]
      html += '</div>'
    }
    html += '</div>'
  }
  html += '<div>'
    html += '<div class="delKey" title="Remove column" tabindex="0">'
    html += 'X'
    html += '</div>'
    html += '<div class="delRows">'
    html += 'X'
    html += '</div>'
  html += '<div class="delRow" tabindex="0">X</div>'.repeat(getRowDelisAmount())
  html += '</div>'  // EO column
  html += '</div>' //  EO table
  document.getElementsByTagName('body')[0].innerHTML = html
  addListeners(keys)
  if(document.getElementsByTagName('input').length > 0) {
    document.getElementsByTagName('input')[0].focus()
  }
}
//
// COLUMN
//
function getColKey(cellEle) {
  var colKey = null
  cellEle = cellEle.parentNode.parentNode
  cellEle = getFirstChild(cellEle)
  cellEle = getNextSibling(cellEle)
  if(cellEle.childNodes.length > 0
    && cellEle.childNodes[0].tagName !== undefined
    && cellEle.childNodes[0].tagName.toLowerCase() == 'input') {
    colKey = cellEle.childNodes[0].value
  }
  else {
    colKey = cellEle.innerHTML
  }
  return colKey
}
//
// ROW
//
function addRow(csv, keys=null) {
  if(keys === null) {
    keys = getKeysOfLocalStorage()
  }
  var vals = csv.split(cellDeli)
  for(var i in keys) {
    var key = keys[i]
    if(localStorage.getItem(key) === null) {
      addKey(key, keys)
    }
    var oldVals = localStorage.getItem(key)
    var newVals = oldVals + cellDeli + vals[i]
    localStorage.setItem(key, newVals)
  }
  showTable(keys)
}
function getRowDelisAmount() {
  var amount = 0
  var keys = getKeysOfLocalStorage()
  if(keys[0] !== undefined &&
     localStorage.getItem(keys[0]) !== null) {
    amount = localStorage.getItem([keys[0]]).split(cellDeli).length - 1
  }
  return amount
}
function getRowNr(cellEle) {
  var rowNr = 0
  var previousEle = cellEle
  while(previousEle !== null) {
    previousEle = previousEle.previousSibling
    if(previousEle !== null) {
      while (previousEle.nodeType != 1) {
        previousEle = previousEle.previousSibling
      }
    }
    rowNr +=1
  }
  rowNr -= 2 // subtract first two cells: input and column-header
  return rowNr
}
function delRow(pos, keys=null) {
  if(keys === null) {
    keys = getKeysOfLocalStorage()
  }
  for(var i in keys) {
    var vals = localStorage.getItem(keys[i])
    vals = vals.split(cellDeli)
    vals.splice(pos, 1)
    vals.join(cellDeli)
    localStorage.setItem(keys[i], vals)
  }
}
//
// LISTEN
//
function addButtonsListener(keys) {
  var addKeyButton = document.getElementsByClassName('addKey')[0]
  var editCellButtons = document.getElementsByClassName('editCell')
  var delKeyButton = document.getElementsByClassName('delKey')[0]
  var delRowButtons = document.getElementsByClassName('delRow')
  var delRowsButton = document.getElementsByClassName('delRows')[0]
  addKeyButton.onclick = function(eve) {
      addKeyButton.innerHTML = '<input>'
      var addKeyInput = addKeyButton.getElementsByTagName('input')[0]
      addKeyInput.focus()
      addKeyInput.onkeydown = function(eve) {
        if(eve.keyCode == 13) {
          keys = addKey(addKeyInput.value, keys)
        }
      }
  }
  addKeyButton.onkeydown = function(eve) {
    if(eve.keyCode == 13) {
      eve.target.click()
    }
  }
  for(var i in editCellButtons) {
    editCellButtons[i].onclick = function(eve) {
      if(eve.target.tagName.toLowerCase() != 'input'
        ||
        (eve.target.childNodes.length > 0
          &&
         eve.target.childNodes[0].tagName.toLowerCase != 'input'
        )
      ) {
        var cellText = eve.target.innerHTML
        eve.target.innerHTML = '<input value="' + eve.target.innerHTML  + '">'
        var editCell = eve.target
        var editCellInput = eve.target.getElementsByTagName('input')[0]
        editCellInput.focus()
        editCellInput.onkeydown = function(eve) {
          if(eve.keyCode == 13) {
            saveCell(eve.target, cellText)
            editCell.innerHTML = eve.target.value
            editCell.focus()
          }
        }
        editCellInput.onblur = function(eve) {
          saveCell(eve.target, cellText)
          editCell.innerHTML = eve.target.value
          //showTable()
        }
      }
    }
    editCellButtons[i].onkeydown = function(eve) {
      if(eve.keyCode == 13) {
        eve.target.click()
      }
    }
  }
  delKeyButton.onclick = function(eve) {
    delKeyButton.innerHTML = '<input>'
    var delKeyInput = delKeyButton.getElementsByTagName('input')[0]
    delKeyInput.focus()
    delKeyInput.onkeydown = function(eve) {
      if(eve.keyCode == 13) {
        delKey(delKeyInput.value)
      }
    }
  }
  delKeyButton.onkeydown = function(eve) {
    if(eve.keyCode == 13) {
      eve.target.click()
    }
  }
  for(var i in delRowButtons) {
    delRowButtons[i].onclick = function(eve) {
      var pos = getRowNr(eve.target)
      delRow(pos)
      showTable(keys)
    }
    delRowButtons[i].onkeydown = function(eve) {
      if(eve.keyCode == 13) {
        eve.target.click()
      }
    }
  }
  delRowsButton.onclick = function(eve) {
    localStorage.clear()
    showTable()
  }
  delRowsButton.onkeydown = function(eve) {
    if(eve.keyCode == 13) {
      eve.target.click()
    }
  }
}
function saveCell(editCellInputEle, oldKey=null) {
  var rowNr = getRowNr(editCellInputEle.parentNode)
  if(rowNr == 0) { // is column-header
    editKey(oldKey, editCellInputEle.value)
  }
  else { // is ordinary-cell
    var colKey = getColKey(editCellInputEle)
    var val = editCellInputEle.value
    var vals = localStorage.getItem(colKey).split(cellDeli)
    vals[rowNr] = val
    vals = vals.join(cellDeli)
    localStorage.setItem(colKey, vals)
  }
}
function addInputsListener(keys) {
  var inputs = document.getElementsByTagName('input')
  for(var i in inputs) {
    var input = inputs[i]
    input.onkeydown = function(eve) {
      if(eve.keyCode == 13) {
        var vals = ''
        for(var j in inputs) {
          if(typeof(inputs[j]) == 'object') {
            vals += inputs[j].value + cellDeli
          }
        }
        vals = vals.slice(0, -cellDeli.length)
        addRow(vals, keys)
      }
    }
  }
}
function getPreviousCousin(ele) {
}
function getPosInParent(ele) {
  var pos = 0
  while(ele.previousSibling !== null) {
    if(ele.previousSibling === null) { break }
    ele = ele.previousSibling
    pos += 1
  }
  return pos
}
function addArrowKeysListener() {
  document.body.onkeydown = function(eve) {
    if(eve.keyCode == 37
    || eve.keyCode == 38
    || eve.keyCode == 39
    || eve.keyCode == 40) {
      var currentEle = document.activeElement

      // If we'Re in an input, go one up, into cell:
      if(currentEle.tagName.toLowerCase() == 'input') {
        currentEle = currentEle.parentNode
      }

      // Arrow-left or arrow-right was pressed:
      if(eve.keyCode == 37 || eve.keyCode == 39) { 

        var pos = getPosInParent(currentEle)

        // First, grab parent:
        currentEle = currentEle.parentNode
        
        // Arrow-left was pressed:
        if(eve.keyCode == 37) {
          // Get previous uncle:
          if(currentEle.previousSibling !== null) {
            currentEle = currentEle.previousSibling
          }
        }
        // Arrow-right was pressed:
        if(eve.keyCode == 39) {
          // Get next uncle:
          if(currentEle.nextSibling !== null) {
            currentEle = currentEle.nextSibling
          }
        }

        // Now, get cousin of same position:
        currentEle = currentEle.childNodes[pos]

        currentEle.focus()
      }




      else if(eve.keyCode == 38) { // arrow-up
        if(currentEle.previousSibling != null) {
          currentEle.previousSibling.focus()
        }
      }
      else if(eve.keyCode == 39) { // arrow-right
      }
      else if(eve.keyCode == 40) { // arrow-down
        if(currentEle.nextSibling != null) {
          currentEle.nextSibling.focus()
        }
      }
    }
  }
}
function addListeners(keys) {
  addButtonsListener(keys)
  addInputsListener(keys)
  addArrowKeysListener(keys)
}
//
// MAIN
//
document.addEventListener("DOMContentLoaded", function(event) { 
  var csv = '2,1,0\nFirstname,Lastname,Passion\nIda,Ebkes,Python\nAda,Ebkes,Lion'
//  setTable(csv)
//  var keys = csv.split(columnDeli)[0].split(cellDeli)
  var keys = getKeysOfLocalStorage() 
  showTable(keys)
}); // dom loaded
</script>
</head>
<body lang="en" dir="ltr">
</body>
</html>
